<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin Ujian Sekolah</title>
    
    <!-- 1. STYLE -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- 2. LIBRARY SUPABASE -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- 3. CSS -->
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .login-card { max-width: 400px; margin: 100px auto; }
        
        .badge-blocked { background-color: #dc3545; animation: blink 1s infinite; }
        .badge-active { background-color: #198754; }
        .badge-finished { background-color: #6c757d; }
        @keyframes blink { 50% { opacity: 0.5; } }
        
        .nav-pills .nav-link.active { background-color: #0d6efd; }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="login-view" class="container">
        <div class="card login-card p-4">
            <h3 class="text-center mb-4">üîê Login Admin</h3>
            <div class="mb-3">
                <label>Email Admin</label>
                <input type="email" id="login-email" class="form-control" placeholder="admin@sekolah.id">
            </div>
            <div class="mb-3">
                <label>Password</label>
                <input type="password" id="login-password" class="form-control" placeholder="********">
            </div>
            <button onclick="doLogin()" class="btn btn-primary w-100 fw-bold">MASUK</button>
            <p id="login-error" class="text-danger text-center mt-3 small"></p>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard-view" style="display: none;">
        <nav class="navbar navbar-dark bg-primary px-4 shadow-sm">
            <span class="navbar-brand"><i class="bi bi-shield-lock"></i> Secure Exam Admin</span>
            <div>
                <span id="admin-name" class="text-white me-3 small">Admin</span>
                <button onclick="doLogout()" class="btn btn-sm btn-light text-primary fw-bold">Keluar</button>
            </div>
        </nav>

        <div class="container mt-4">
            <!-- Tabs -->
            <ul class="nav nav-pills mb-4 bg-white p-2 rounded shadow-sm" id="pills-tab" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-monitor" type="button" onclick="fetchMonitoring()">Monitoring</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-exams" type="button" onclick="fetchExams()">Bank Soal</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-students" type="button" onclick="fetchStudents()">Data Siswa</button>
                </li>
            </ul>

            <!-- Isi Tabs -->
            <div class="tab-content">
                <!-- MONITORING -->
                <div class="tab-pane fade show active" id="tab-monitor">
                    <div class="d-flex justify-content-between mb-3">
                        <h5>Status Siswa Live</h5>
                        <button onclick="fetchMonitoring()" class="btn btn-sm btn-secondary">Refresh</button>
                    </div>
                    <div class="card p-0">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr><th>Nama</th><th>Ujian</th><th>Waktu</th><th>Status</th><th>Aksi</th></tr>
                            </thead>
                            <tbody id="monitor-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- BANK SOAL -->
                <div class="tab-pane fade" id="tab-exams">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card p-3 mb-3">
                                <h6>Tambah Ujian</h6>
                                <input type="text" id="exam-title" class="form-control mb-2" placeholder="Judul">
                                <input type="text" id="exam-link" class="form-control mb-2" placeholder="Link Form">
                                <input type="text" id="exam-token" class="form-control mb-2" placeholder="TOKEN">
                                <button onclick="createExam()" class="btn btn-primary w-100">Simpan</button>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card p-0">
                                <table class="table mb-0"><tbody id="exam-table-body"></tbody></table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DATA SISWA -->
                <div class="tab-pane fade" id="tab-students">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card p-3 mb-3 border-warning">
                                <h6>Daftar Siswa Baru</h6>
                                <input type="text" id="std-name" class="form-control mb-2" placeholder="Nama">
                                <input type="email" id="std-email" class="form-control mb-2" placeholder="Email">
                                <input type="password" id="std-pass" class="form-control mb-2" placeholder="Password">
                                <button onclick="createStudent()" class="btn btn-warning w-100">Daftarkan</button>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card p-3"><table class="table"><tbody id="student-table-body"></tbody></table></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ========================================= -->
    <!-- LOGIKA JAVASCRIPT -->
    <!-- ========================================= -->
    <script>
        // --- KONFIGURASI SUPABASE ANDA ---
        const MY_SUPABASE_URL = 'https://patjsszankjdlnktrfmh.supabase.co'; 
        const MY_ANON_KEY     = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhdGpzc3phbmtqZGxua3RyZm1oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3NzEzODUsImV4cCI6MjA2OTM0NzM4NX0.eZLV-7HbhQMFS3EF4e-Q5UuPRKVssgirL1cQxj7yJEg'; 
        const MY_SERVICE_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhdGpzc3phbmtqZGxua3RyZm1oIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzc3MTM4NSwiZXhwIjoyMDY5MzQ3Mzg1fQ.Xo3JynOBufjcAuHjN3mK4pAIC7xnEraAm0TuehhSRWg'; 

        // Inisialisasi dengan nama variabel unik "dbClient"
        const dbClient = window.supabase.createClient(MY_SUPABASE_URL, MY_ANON_KEY);
        // Client khusus admin dengan Service Key
        const adminClient = window.supabase.createClient(MY_SUPABASE_URL, MY_SERVICE_KEY);

        // --- AUTH ---
        async function doLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            // Menggunakan dbClient
            const { data, error } = await dbClient.auth.signInWithPassword({ email, password });
            
            if (error) {
                document.getElementById('login-error').innerText = "Error: " + error.message;
            } else {
                checkRole();
            }
        }

        async function doLogout() {
            await dbClient.auth.signOut();
            window.location.reload();
        }

        async function checkRole() {
            const { data: { user } } = await dbClient.auth.getUser();
            if (!user) return;

            const { data: profile } = await dbClient
                .from('profiles')
                .select('role, full_name')
                .eq('id', user.id)
                .single();

            if (profile && profile.role === 'admin') {
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('dashboard-view').style.display = 'block';
                document.getElementById('admin-name').innerText = profile.full_name || user.email;
                fetchMonitoring();
                subscribeRealtime();
            } else {
                alert("Login berhasil, tapi Anda bukan Admin! Akses ditolak.");
                await dbClient.auth.signOut();
            }
        }
        checkRole(); // Cek saat load

        // --- MONITORING ---
        async function fetchMonitoring() {
            const tbody = document.getElementById('monitor-table-body');
            const { data: sessions } = await dbClient
                .from('sessions')
                .select(`id, status, updated_at, profiles:user_id(full_name), exams:exam_id(title)`)
                .order('updated_at', { ascending: false });

            tbody.innerHTML = '';
            if (sessions) {
                sessions.forEach(s => {
                    let badge = 'bg-secondary';
                    let btn = '-';
                    if (s.status === 'active') badge = 'badge-active';
                    if (s.status === 'blocked') {
                        badge = 'badge-blocked';
                        btn = `<button onclick="unlockStudent('${s.id}')" class="btn btn-sm btn-warning">BUKA</button>`;
                    }
                    tbody.innerHTML += `<tr>
                        <td>${s.profiles?.full_name || 'X'}</td>
                        <td>${s.exams?.title || 'X'}</td>
                        <td>${new Date(s.updated_at).toLocaleTimeString()}</td>
                        <td><span class="badge ${badge}">${s.status}</span></td>
                        <td>${btn}</td>
                    </tr>`;
                });
            }
        }

        async function unlockStudent(id) {
            if(confirm('Buka akses siswa ini?')) await dbClient.from('sessions').update({ status: 'active' }).eq('id', id);
        }

        function subscribeRealtime() {
            dbClient.channel('admin-dash')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'sessions' }, fetchMonitoring)
                .subscribe();
        }

        // --- UJIAN ---
        async function fetchExams() {
            const { data: exams } = await dbClient.from('exams').select('*').order('created_at', { ascending: false });
            const tbody = document.getElementById('exam-table-body');
            tbody.innerHTML = '';
            exams.forEach(e => {
                tbody.innerHTML += `<tr><td>${e.title}</td><td>${e.token}</td><td>Link OK</td><td><button onclick="delExam('${e.id}')" class="btn btn-danger btn-sm">X</button></td></tr>`;
            });
        }
        async function createExam() {
            const title = document.getElementById('exam-title').value;
            const link = document.getElementById('exam-link').value;
            const token = document.getElementById('exam-token').value;
            if(title) {
                await dbClient.from('exams').insert([{ title, link_url: link, token }]);
                fetchExams();
                alert("Ujian Tersimpan");
            }
        }
        async function delExam(id) {
            if(confirm('Hapus ujian ini?')) {
                await dbClient.from('exams').delete().eq('id', id);
                fetchExams();
            }
        }

        // --- SISWA ---
        async function createStudent() {
            const email = document.getElementById('std-email').value;
            const password = document.getElementById('std-pass').value;
            const name = document.getElementById('std-name').value;
            if(email && password) {
                // Menggunakan adminClient (Service Key) untuk bypass login
                const { error } = await adminClient.auth.admin.createUser({
                    email, password, email_confirm: true, user_metadata: { full_name: name }
                });
                if(error) alert("Gagal: " + error.message);
                else { alert("Siswa Berhasil Didaftarkan!"); fetchStudents(); }
            }
        }
        async function fetchStudents() {
            const { data: profiles } = await dbClient.from('profiles').select('*').eq('role', 'student');
            const tbody = document.getElementById('student-table-body');
            tbody.innerHTML = '';
            if(profiles) {
                profiles.forEach(p => {
                    tbody.innerHTML += `<tr><td>${p.full_name}</td><td>Siswa</td><td>Aktif</td></tr>`;
                });
            }
        }
    </script>
</body>
</html>
